<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de bord utilisateurs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-5">
        <h2 class="mb-4">Gestion des utilisateurs</h2>
        <button class="btn btn-success mb-3" onclick="showUserForm()">Ajouter un utilisateur</button>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Prénom</th>
                    <th>Email</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="usersTableBody"></tbody>
        </table>

        <!-- Formulaire utilisateur (ajout/modif) -->
        <div id="userFormContainer" style="display:none;">
            <h4 id="formTitle">Ajouter un utilisateur</h4>
            <form id="userForm">
                <input type="hidden" id="userId">
                <div class="mb-3">
                    <label for="name" class="form-label">Nom</label>
                    <input type="text" class="form-control" id="name" required>
                </div>
                <div class="mb-3">
                    <label for="firstname" class="form-label">Prénom</label>
                    <input type="text" class="form-control" id="firstname" required>
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Mot de passe</label>
                    <input type="password" class="form-control" id="password">
                </div>
                <button type="submit" class="btn btn-primary">Valider</button>
                <button type="button" class="btn btn-secondary" onclick="hideUserForm()">Annuler</button>
            </form>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/';

        // Afficher/Masquer le formulaire
        function showUserForm(user = null) {
            document.getElementById('userFormContainer').style.display = 'block';
            document.getElementById('formTitle').textContent = user ? 'Modifier un utilisateur' : 'Ajouter un utilisateur';
            document.getElementById('userId').value = user ? user._id : '';
            document.getElementById('name').value = user ? user.name : '';
            document.getElementById('firstname').value = user ? user.firstname : '';
            document.getElementById('email').value = user ? user.email : '';
            document.getElementById('password').value = '';
        }
        function hideUserForm() {
            document.getElementById('userFormContainer').style.display = 'none';
        }

        // Charger les utilisateurs
        async function loadUsers() {
            const res = await fetch('/users', { headers: { 'Authorization': token } });
            const users = await res.json();
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>${u.name}</td>
                    <td>${u.firstname}</td>
                    <td>${u.email}</td>
                    <td>
                        <button class='btn btn-warning btn-sm' onclick='showUserForm(${JSON.stringify(u)})'>Modifier</button>
                        <button class='btn btn-danger btn-sm' onclick='deleteUser("${u._id}")'>Supprimer</button>
                    </td>
                </tr>
            `).join('');
        }

        // Ajouter/Modifier utilisateur
        document.getElementById('userForm').onsubmit = async function (e) {
            e.preventDefault();
            const id = document.getElementById('userId').value;
            const method = id ? 'PATCH' : 'PUT';
            const url = id ? `/users/${id}` : '/users/add';
            const body = {
                name: document.getElementById('name').value,
                firstname: document.getElementById('firstname').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value
            };
            await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json', 'Authorization': token },
                body: JSON.stringify(body)
            });
            hideUserForm();
            loadUsers();
        };

        // Supprimer utilisateur
        async function deleteUser(id) {
            if (!confirm('Supprimer cet utilisateur ?')) return;
            await fetch(`/users/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': token }
            });
            loadUsers();
        }

        loadUsers();
    </script>
</body>

</html>